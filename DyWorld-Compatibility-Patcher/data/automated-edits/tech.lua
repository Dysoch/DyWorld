



local Tech_Act_2 = {
	["automation-science-pack"] = {Replace = "iron-plate", Ratio = 2.5},
	["logistic-science-pack"] = {Replace = "iron-plate", Ratio = 2.5},
	["chemical-science-pack"] = {Replace = "iron-plate", Ratio = 2.5},
	["military-science-pack"] = {Replace = "iron-plate", Ratio = 2.5},
	["production-science-pack"] = {Replace = "iron-plate", Ratio = 2.5},
	["utility-science-pack"] = {Replace = "iron-plate", Ratio = 2.5},
	["space-science-pack"] = {Replace = "iron-plate", Ratio = 2.5}, 
}

local Tech_Act_3 = {
	["automation-science-pack"] = {Replace = "canister-empty", Ratio = 2.5},
	["logistic-science-pack"] = {Replace = "canister-empty", Ratio = 2.5},
	["chemical-science-pack"] = {Replace = "canister-empty", Ratio = 2.5},
	["military-science-pack"] = {Replace = "canister-empty", Ratio = 2.5},
	["production-science-pack"] = {Replace = "canister-empty", Ratio = 2.5},
	["utility-science-pack"] = {Replace = "canister-empty", Ratio = 2.5},
	["space-science-pack"] = {Replace = "canister-empty", Ratio = 2.5},
}

local Tech_Main = {
	["automation-science-pack"] = {Replace = "dysci-01"},
	["logistic-science-pack"] = {Replace = "dysci-02"},
	["chemical-science-pack"] = {Replace = "dysci-03"},
	["military-science-pack"] = {Replace = "dysci-04"},
	["production-science-pack"] = {Replace = "dysci-05"},
	["utility-science-pack"] = {Replace = "dysci-06"},
	["space-science-pack"] = {Replace = "dysci-07"},
}

local Tech_Base_Game = {
	["physical-projectile-damage-1"] = {Replace = nil},
	["physical-projectile-damage-2"] = {Replace = nil},
	["physical-projectile-damage-3"] = {Replace = nil},
	["physical-projectile-damage-4"] = {Replace = nil},
	["physical-projectile-damage-5"] = {Replace = nil},
	["physical-projectile-damage-6"] = {Replace = nil},
	["physical-projectile-damage-7"] = {Replace = nil},
	["weapon-shooting-speed-1"] = {Replace = nil},
	["weapon-shooting-speed-2"] = {Replace = nil},
	["weapon-shooting-speed-3"] = {Replace = nil},
	["weapon-shooting-speed-4"] = {Replace = nil},
	["weapon-shooting-speed-5"] = {Replace = nil},
	["weapon-shooting-speed-6"] = {Replace = nil},
	["stronger-explosives-1"] = {Replace = nil},
	["stronger-explosives-2"] = {Replace = nil},
	["stronger-explosives-3"] = {Replace = nil},
	["stronger-explosives-4"] = {Replace = nil},
	["stronger-explosives-5"] = {Replace = nil},
	["stronger-explosives-6"] = {Replace = nil},
	["stronger-explosives-7"] = {Replace = nil},
	["refined-flammables-1"] = {Replace = nil},
	["refined-flammables-2"] = {Replace = nil},
	["refined-flammables-3"] = {Replace = nil},
	["refined-flammables-4"] = {Replace = nil},
	["refined-flammables-5"] = {Replace = nil},
	["refined-flammables-6"] = {Replace = nil},
	["refined-flammables-7"] = {Replace = nil},
	["energy-weapons-damage-1"] = {Replace = nil},
	["energy-weapons-damage-2"] = {Replace = nil},
	["energy-weapons-damage-3"] = {Replace = nil},
	["energy-weapons-damage-4"] = {Replace = nil},
	["energy-weapons-damage-5"] = {Replace = nil},
	["energy-weapons-damage-6"] = {Replace = nil},
	["energy-weapons-damage-7"] = {Replace = nil},
	["laser-shooting-speed-1"] = {Replace = nil},
	["laser-shooting-speed-2"] = {Replace = nil},
	["laser-shooting-speed-3"] = {Replace = nil},
	["laser-shooting-speed-4"] = {Replace = nil},
	["laser-shooting-speed-5"] = {Replace = nil},
	["laser-shooting-speed-6"] = {Replace = nil},
	["laser-shooting-speed-7"] = {Replace = nil},
	["artillery-shell-range-1"] = {Replace = nil},
	["artillery-shell-speed-1"] = {Replace = nil},
	["follower-robot-count-1"] = {Replace = nil},
	["follower-robot-count-2"] = {Replace = nil},
	["follower-robot-count-3"] = {Replace = nil},
	["follower-robot-count-4"] = {Replace = nil},
	["follower-robot-count-5"] = {Replace = nil},
	["follower-robot-count-6"] = {Replace = nil},
	["follower-robot-count-7"] = {Replace = nil},
	["stack-inserter"] = {Replace = nil},
	["inserter-capacity-bonus-1"] = {Replace = nil},
	["inserter-capacity-bonus-2"] = {Replace = nil},
	["inserter-capacity-bonus-3"] = {Replace = nil},
	["inserter-capacity-bonus-4"] = {Replace = nil},
	["inserter-capacity-bonus-5"] = {Replace = nil},
	["inserter-capacity-bonus-6"] = {Replace = nil},
	["inserter-capacity-bonus-7"] = {Replace = nil},
	["automation"] = {Replace = "automatica-1"},
	["automation-2"] = {Replace = "automatica-3"},
	["automation-3"] = {Replace = "automatica-5"},
	["electronics"] = {Replace = nil},
	["advanced-electronics"] = {Replace = "intermediates-3"},
	["advanced-electronics-2"] = {Replace = "intermediates-6"},
	["steel-axe"] = {Replace = nil},
	["military"] = {Replace = "warfare-1"},
	["military-2"] = {Replace = "warfare-3"},
	["military-3"] = {Replace = "warfare-5"},
	["military-4"] = {Replace = "warfare-7"},
	["fast-inserter"] = {Replace = nil},
	["logistics"] = {Replace = "logistica-1"},
	["logistics-2"] = {Replace = "logistica-3"},
	["logistics-3"] = {Replace = "logistica-5"},
	["fluid-wagon"] = {Replace = nil},
	["railway"] = {Replace = "rails-1"},
	["automated-rail-transportation"] = {Replace = "rails-1"},
	["rail-signals"] = {Replace = "rails-1"},
	["automobilism"] = {Replace = nil},
	["solar-energy"] = {Replace = "power-1"},
	["electric-energy-accumulators"] = {Replace = "power-3"},
	["heavy-armor"] = {Replace = nil},
	["gun-turret"] = {Replace = nil},
	["research-speed-1"] = {Replace = nil},
	["research-speed-2"] = {Replace = nil},
	["research-speed-3"] = {Replace = nil},
	["research-speed-4"] = {Replace = nil},
	["research-speed-5"] = {Replace = nil},
	["research-speed-6"] = {Replace = nil},
	["electric-energy-distribution-1"] = {Replace = "power-1"},
	["electric-energy-distribution-2"] = {Replace = "power-3"},
	["advanced-material-processing"] = {Replace = "automatica-4"},
	["advanced-material-processing-2"] = {Replace = "automatica-6"},
	["concrete"] = {Replace = "intermediates-5"},
	["engine"] = {Replace = "intermediates-1"},
	["landfill"] = {Replace = nil},
	["toolbelt"] = {Replace = nil},
	["stone-wall"] = {Replace = nil},
	["gate"] = {Replace = nil},
	["uranium-ammo"] = {Replace = nil},
	["atomic-bomb"] = {Replace = nil},
	["explosives"] = {Replace = nil},
	["cliff-explosives"] = {Replace = nil},
	["flammables"] = {Replace = nil},
	["land-mine"] = {Replace = nil},
	["flamethrower"] = {Replace = nil},
	["braking-force-1"] = {Replace = nil},
	["braking-force-2"] = {Replace = nil},
	["braking-force-3"] = {Replace = nil},
	["braking-force-4"] = {Replace = nil},
	["braking-force-5"] = {Replace = nil},
	["braking-force-6"] = {Replace = nil},
	["braking-force-7"] = {Replace = nil},
	["tank"] = {Replace = nil},
	["laser"] = {Replace = nil},
	["rocketry"] = {Replace = nil},
	["explosive-rocketry"] = {Replace = nil},
	["modular-armor"] = {Replace = nil},
	["power-armor"] = {Replace = nil},
	["power-armor-mk2"] = {Replace = nil},
	["laser-turret"] = {Replace = nil},
	["robotics"] = {Replace = "storage-2"},
	["rocket-fuel"] = {Replace = "gasoline"},
	["low-density-structure"] = {Replace = "intermediates-6"},
	["rocket-control-unit"] = {Replace = "intermediates-6"},
	["rocket-silo"] = {Replace = "space-mining"},
	["effect-transmission"] = {Replace = nil},
	["lubricant"] = {Replace = "intermediates-2"},
	["electric-engine"] = {Replace = "intermediates-3"},
	["battery"] = {Replace = "intermediates-5"},
	["construction-robotics"] = {Replace = "storage-3"},
	["logistic-robotics"] = {Replace = "storage-3"},
	["logistic-system"] = {Replace = "storage-5"},
	["worker-robots-speed-1"] = {Replace = nil},
	["worker-robots-speed-2"] = {Replace = nil},
	["worker-robots-speed-3"] = {Replace = nil},
	["worker-robots-speed-4"] = {Replace = nil},
	["worker-robots-speed-5"] = {Replace = nil},
	["worker-robots-speed-6"] = {Replace = nil},
	["worker-robots-storage-1"] = {Replace = nil},
	["worker-robots-storage-2"] = {Replace = nil},
	["worker-robots-storage-3"] = {Replace = nil},
	["energy-shield-equipment"] = {Replace = nil},
	["night-vision-equipment"] = {Replace = nil},
	["belt-immunity-equipment"] = {Replace = nil},
	["energy-shield-mk2-equipment"] = {Replace = nil},
	["battery-equipment"] = {Replace = nil},
	["battery-mk2-equipment"] = {Replace = nil},
	["solar-panel-equipment"] = {Replace = nil},
	["personal-laser-defense-equipment"] = {Replace = nil},
	["discharge-defense-equipment"] = {Replace = nil},
	["fusion-reactor-equipment"] = {Replace = nil},
	["exoskeleton-equipment"] = {Replace = nil},
	["personal-roboport-equipment"] = {Replace = nil},
	["personal-roboport-mk2-equipment"] = {Replace = nil},
	["fluid-handling"] = {Replace = "fluids-1"},
	["advanced-oil-processing"] = {Replace = "oil-processing"},
	["coal-liquefaction"] = {Replace = "oil-processing"},
	["sulfur-processing"] = {Replace = "intermediates-5"},
	["plastics"] = {Replace = "intermediates-3"},
	["modules"] = {Replace = nil},
	["speed-module"] = {Replace = nil},
	["speed-module-2"] = {Replace = nil},
	["speed-module-3"] = {Replace = nil},
	["productivity-module"] = {Replace = nil},
	["productivity-module-2"] = {Replace = nil},
	["productivity-module-3"] = {Replace = nil},
	["effectivity-module"] = {Replace = nil},
	["effectivity-module-2"] = {Replace = nil},
	["effectivity-module-3"] = {Replace = nil},
	["defender"] = {Replace = nil},
	["distractor"] = {Replace = nil},
	["destroyer"] = {Replace = nil},
	["uranium-processing"] = {Replace = "nuclear-1"},
	["nuclear-power"] = {Replace = "nuclear-2"},
	["kovarex-enrichment-process"] = {Replace = "nuclear-3"},
	["nuclear-fuel-reprocessing"] = {Replace = "nuclear-4"},
	["mining-productivity-1"] = {Replace = nil},
	["mining-productivity-2"] = {Replace = nil},
	["mining-productivity-3"] = {Replace = nil},
	["mining-productivity-4"] = {Replace = nil},
	["artillery"] = {Replace = nil},
	["spidertron"] = {Replace = nil},
	["circuit-network"] = {Replace = "intermediates-3"},
	["logistic-science-pack"] = {Replace = "dy-science-pack-2"},
	["chemical-science-pack"] = {Replace = "dy-science-pack-3"},
	["military-science-pack"] = {Replace = "dy-science-pack-4"},
	["production-science-pack"] = {Replace = "dy-science-pack-5"},
	["utility-science-pack"] = {Replace = "dy-science-pack-6"},
	["space-science-pack"] = {Replace = "dy-science-pack-7"},
}

for _, tech in pairs (data.raw.technology) do
	if not tech.DyWorld_Hider then
		if tech.flag and tech.flag.Act_2 then
			if tech.unit and tech.unit.ingredients then
				for k,v in pairs(tech.unit.ingredients) do
					for Old,New in pairs(Tech_Act_2) do
						if v[1] == Old then
							--Dy_Log("DyComPa: Found old science-pack ("..Old..") in act-2 technology: "..tech.name..". Removing it from technology")
							data.raw.technology[tech.name].unit.ingredients[k] = nil
						end
					end
				end
			end
		end
		if tech.flag and tech.flag.Act_3 then
			if tech.unit and tech.unit.ingredients then
				for k,v in pairs(tech.unit.ingredients) do
					for Old,New in pairs(Tech_Act_3) do
						if v[1] == Old then
							--Dy_Log("DyComPa: Found old science-pack ("..Old..") in act-3 technology: "..tech.name..". Removing it from technology")
							data.raw.technology[tech.name].unit.ingredients[k] = nil
						end
					end
				end
			end
		end
		if tech.unit and tech.unit.ingredients then
			for k,v in pairs(tech.unit.ingredients) do
				for Old,New in pairs(Tech_Main) do
					if v[1] == Old then
						--Dy_Log("DyComPa: Found old science-pack ("..Old..") in technology: "..tech.name..". Changing pack to: "..New.Replace)
						v[1] = New.Replace
					end
				end
			end
		end
		if tech.prerequisites then
			for k,v in pairs(tech.prerequisites) do
				for Old,New in pairs(Tech_Base_Game) do
					if v == Old then
						if New.Replace ~= nil then
							if data.raw.technology[New.Replace] then
								if v[New.Replace] then
									Dy_Log("DyComPa: Found Factorio technology prerequisite ("..Old..") in technology: "..tech.name..". Replacing not needed, since "..New.Replace.." already exists. Removing old prerequisite")
									v = nil
								else
									Dy_Log("DyComPa: Found Factorio technology prerequisite ("..Old..") in technology: "..tech.name..". Changing it to: "..New.Replace)
									v = New.Replace
								end
							else
								Dy_Log("DyComPa: Found Factorio technology prerequisite ("..Old..") in technology: "..tech.name..". Replacing tech ("..New.Replace..") not found, removing it completely")
								v = nil
							end
						else
							Dy_Log("DyComPa: Found Factorio technology prerequisite ("..Old..") in technology: "..tech.name..". No substitute found, removing it completely")
							v = nil
						end
					end
				end
			end
		end
		if (tech.unit and tech.unit.count and tonumber(tech.unit.count) > 1) then
			local AMOUNT = tech.unit.count
			if tech.unit.ingredients then
				for k,v in pairs(tech.unit.ingredients) do
					if math.ceil(v[2] * AMOUNT) >= 65000 then
						v[2] = 65000
					elseif math.ceil(v[2] * AMOUNT) <= 1 then
						v[2] = 1
					else
						v[2] = (math.ceil(v[2] * AMOUNT))
					end
				end
			end
			if tech.unit.time then
				tech.unit.time = math.ceil(tech.unit.time * AMOUNT)
			end
			tech.unit.count = 1
		end
	end
end